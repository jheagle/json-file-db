"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.matchIndexedJoins=void 0,require("core-js/modules/esnext.async-iterator.reduce.js"),require("core-js/modules/esnext.iterator.constructor.js"),require("core-js/modules/esnext.iterator.reduce.js");var _siFunciona=_interopRequireDefault(require("si-funciona")),_where=require("../queries/where"),_retrieveFile=require("./retrieveFile"),_splitEntityProperty=require("./parsers/splitEntityProperty");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __awaiter=function(e,t,r,i){return new(r||(r=Promise))((function(n,o){function s(e){try{y(i.next(e))}catch(e){o(e)}}function p(e){try{y(i.throw(e))}catch(e){o(e)}}function y(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,p)}y((i=i.apply(e,t||[])).next())}))};const matchIndexedJoins=(e,t,r)=>(i,n,o,s,p,y)=>__awaiter(void 0,void 0,void 0,(function*(){const{entity:i,property:n}=(0,_splitEntityProperty.splitEntityProperty)(s.propertyA),{entity:o,property:c}=(0,_splitEntityProperty.splitEntityProperty)(s.propertyB),u=[{entityFirst:i,propertyFirst:n,entitySecond:o,propertySecond:c},{entityFirst:o,propertyFirst:c,entitySecond:i,propertySecond:n}];for(let i of u){t.hasOwnProperty(i.entitySecond)||(t[i.entitySecond]=_siFunciona.default.cloneObject(y[i.entitySecond]));const n=t[i.entitySecond][i.propertySecond].reduce(((e,r)=>_siFunciona.default.mergeArrays(e,(0,_where.where)(t[i.entityFirst][i.propertyFirst],{property:"value",comparator:s.comparator,value:r.value}))),[]);let o=i.entityFirst===e;r.hasOwnProperty(i.entityFirst)||(r[i.entityFirst]=[]);for(let e of n)for(let t of e.record){let e=t;"string"==typeof t&&(e=yield(0,_retrieveFile.retrieveFile)(`${i.entityFirst}/${t}`)),o||r[i.entityFirst].push(e),p[i.entityFirst].push(e)}}}));exports.matchIndexedJoins=matchIndexedJoins;