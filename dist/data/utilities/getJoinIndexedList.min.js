"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.getJoinIndexedList=void 0;var _siFunciona=_interopRequireDefault(require("si-funciona")),_splitEntityProperty=require("./parsers/splitEntityProperty"),_retrieveRecord=require("./retrieveRecord"),_getMatchingIndexes=require("./getMatchingIndexes"),_matchIndexedJoins=require("./matchIndexedJoins"),_restrictIndexedList=require("./restrictIndexedList");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}var __awaiter=function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function s(e){try{c(i.next(e))}catch(e){o(e)}}function d(e){try{c(i.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,d)}c((i=i.apply(e,t||[])).next())}))};const getJoinIndexedList=(e,t,n)=>__awaiter(void 0,void 0,void 0,(function*(){let i=[];const r={};let o=!0;const s=e.entity,d=e.joinEntity,c=e.joinClauses;for(const e in n[s]){const a=n[s][e];let u={};u[s]=[_siFunciona.default.cloneObject(a)];for(let e of c){let d=_siFunciona.default.cloneObject(r);const{entity:c,property:a}=(0,_splitEntityProperty.splitEntityProperty)(e.propertyA),{entity:p,property:l}=(0,_splitEntityProperty.splitEntityProperty)(e.propertyB);t.hasOwnProperty(c)||(t[c]=yield(0,_retrieveRecord.retrieveRecord)(c)),t.hasOwnProperty(p)||(t[p]=yield(0,_retrieveRecord.retrieveRecord)(p)),d=(0,_restrictIndexedList.restrictIndexedList)(e,u,d);const y=(0,_matchIndexedJoins.matchIndexedJoins)(s,d,n),_=yield(0,_getMatchingIndexes.getMatchingIndexes)(c,a,t,e,u,r),x=yield(0,_getMatchingIndexes.getMatchingIndexes)(p,l,t,e,u,r,y);!(_||x)&&o&&(i.push(e),o=!1)}n[s][e][d]=u[d]}return e.joinClauses=i,e}));exports.getJoinIndexedList=getJoinIndexedList;